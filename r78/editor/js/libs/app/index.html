<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<title>three.js</title>

        <style>

            body {
                font-family: Helvetica, Arial, sans-serif;
                font-size: 12px;
                background-color: #000;
                margin: 0px;
                overflow: hidden;
            }

            #edit {
                position: absolute;
                bottom: 20px;
                right: 20px;
                padding: 8px;
                color: #555;
                background-color: #fff;
                opacity: 0.5;
            }

            #edit:hover {
                cursor: pointer;
                opacity: 1;
            }

		</style>

	</head>

	<body ontouchstart="">

		<script src="/three/three.js"></script>
		<script src="js/app.js"></script>

		<!-- includes -->

		<script>

			(function(){

			//  Loading dialog.

				var loadingDialog = document.createElement("div");
				loadingDialog.id = "loading-dialog"
				loadingDialog.classList.add("middle", "text-center");
				loadingDialog.style.cssText = "position:absolute;top:0;left:0;bottom:0;right:0;background:none;z-index:9999;";

				var dialogContent = document.createElement("h2");
				dialogContent.style.cssText = "width:fit-content;font-weight:bold;color:#fff;text-align:center;"
				dialogContent.innerHTML = "<span id=\"wait\">Please wait...</span>" + "<br>" 
					+ "<span id=\"loading\">Loading... </span>" + "<span id=\"completed\"></span>" 
					+ "<br>" + "<span id=\"duty\">(heavy duty)</span>";

				loadingDialog.appendChild( dialogContent );
				document.body.appendChild( loadingDialog );

			})();

		//

			var loader = new THREE.XHRLoader();
			loader.load( "app.json", function ( text ) {

				var json = JSON.parse( text );

			//	Load external javascirpt libraries.

				function parseScript( item ){ 
					return {
						name: item.name,
						source: JSON.parse( item.source ) // important!
					};
				}

				//	backward.

				if ( json.javascripts && json.javascripts.length > 0 ) {

					var scripts = json.javascripts.map( parseScript );
					debugMode && console.log( "scripts:", scripts );

					while ( scripts.length ) {

						var object = scripts.shift(); // important!
						var script = new Function( object.source );
						script.bind( window ).call(); // bind and execute.
						console.log("Library", object.name, "loaded.");

					}

				}

				//	current.

				if ( json.jslibraries && json.jslibraries.length > 0 ) {

					var scripts = json.jslibraries.map( parseScript );
					debugMode && console.log( "scripts:", scripts );

					while ( scripts.length ) {

						var object = scripts.shift(); // important!
						var script = new Function( object.source );
						script.bind( window ).call(); // bind and execute.
						console.log("Library", object.name, "loaded.");

					}

				}

		//	TODO: immiplication for global functions?

				var app = new APP.Player();

				app.load( json );
				app.setSize( window.innerWidth, window.innerHeight );
				app.play();

				document.body.appendChild( app.dom );

				if ( json.project.editable === true ) {

					var button = document.createElement( "div" );
					button.id = "edit";
					button.textContent = "OPEN TO EDITOR";
					button.addEventListener( 'click', function ( event ) {

						var url = location.href.split( "/" ).slice( 0, - 1 ).join( "/" );
						window.open( "https://sloothes.com/three/r78/editor/#file=" + url + "/app.json" );

					}, false );

					document.body.appendChild( button );

				}

		//

				window.addEventListener( "resize", function () {
					app.setSize( window.innerWidth, window.innerHeight );
				});

		//

				setTimeout(function(){
					var dialog = document.getElementById("loading-dialog");
					dialog.style.display = "none"; dialog.remove();
				}, 1000);

			});

		</script>
	</body>
</html>
