<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<title>three.js</title>

        <style>

            body {
                font-family: Helvetica, Arial, sans-serif;
                font-size: 12px;
                background-color: #000;
                margin: 0px;
                overflow: hidden;
            }

            #edit {
                position: absolute;
                bottom: 20px;
                right: 20px;
                padding: 8px;
                color: #555;
                background-color: #fff;
                opacity: 0.5;
            }

            #edit:hover {
                cursor: pointer;
                opacity: 1;
            }

            .middle > * {
                position:absolute;
                height:fit-content;
                width:fit-content;
                top:0; bottom:0;
                left:0; right:0;
                margin:auto;
            }

		</style>

        <style class="joystick-controls"> 
            .gameinput-button__inner { 
                display:table-cell; vertical-align: middle; 
            } 
            .gameinput-joystick { 
                border:solid 0px white; border-radius:50%; position:absolute; bottom:30px; 
                user-select:none; touch-action:none; -ms-touch-action:none; 
                -webkit-user-select:none; -moz-user-select:none; -ms-user-select:none; 
            } 
            .gameinput-frame { 
                position:absolute; top:0; left:0; pointer-events:none; opacity:0.5; 
            } 
            .gameinput-button { 
                cursor:pointer; text-align:center; position:absolute; display:table; 
                box-sizing:border-box; border:1px solid #333; 
                border-radius:50%; background:rgba( 255, 255, 255, .5 ); 
                user-select:none; touch-action:none; -ms-touch-action:none; 
                -webkit-user-select:none; -moz-user-select:none; -ms-user-select:none; 
            } 
            #joystick1 { bottom:50px; right:40px; width:120px; height:120px;z-index:1; } 
            #joystick2 { bottom:50px; left:40px; width:120px; height:120px; z-index:1;} 
            #jumpButton { right:105px; bottom:240px; z-index:1; } 
            @media ( max-width: 768px ) { 
                #joystick1 { bottom:0px; right:0px; } 
                #joystick2 { bottom:0px; left:0px; } 
                #jumpButton { bottom:190px; right:65px; } 
                .gameinput-joystick { bottom:0px;} 
            } 
            .gameinput-joystick__button { 
                position:absolute; width:72px; height:72px; left:85px; top:85px; cursor:pointer; 
                box-sizing:border-box; border-radius:50%; border:1px solid #333; background:rgba( 255, 255, 255, .5 ); 
            } 
        </style>

		<script src="/socketcluster.js"></script>
		<script src="/sc-codec-min-bin.js"></script>
		<script src="/js/watch.js"></script>
		<script src="/js/jquery.min.js"></script>
		<script src="/js/bootbox.min.js"></script>
		<script src="/js/bootstrap.min.js"></script>
        <script src="/js/validator.min.js"></script>
        <script src="/js/DeviceDetector.js"></script>
        <script src="/js/MathDecimalAdjustment.js"></script>

		<script src="/js/ui.js"></script>
		<script src="/js/ui.three.js"></script>
		<script src="/js/signals.min.js"></script>

		<script src="/three/three.js"></script>
		<script src="/three/system.min.js"></script>

		<script src="/three/Animation.js"></script>
		<script src="/three/AnimationHandler.js"></script>
		<script src="/three/KeyFrameAnimation.js"></script>
		<script src="/three/EditorControls.js"></script> 
		<script src="/three/TransformControls.js"></script> 

	</head>

	<body ontouchstart="">

		<!-- script src="js/app.js"></script -->

		<script>

			var APP = {

				Player: function () {

					var scope = this;

					var loader = new THREE.ObjectLoader();
					var libLoader = new THREE.XHRLoader();

					var libraries;

					var camera, scene, renderer;

					var vr, controls, effect, center;

					var events = {};

					this.dom = document.createElement( "div" );

					this.width = 500;
					this.height = 500;

				//

					this.load = function ( json ) {

						vr = json.project.vr;

						debugMode = json.project.debugMode; // (global) important! 

						THREE.Cache.enabled = json.project.cache; // important!

						console.log({ "vr": vr, "debugMode": debugMode, "cache": THREE.Cache.enabled });
/*
					//	load external javascirpt libraries.

						if ( json.javascript ) { // experimental!

							for ( var i = 0; i < json.javascript.length; i ++ ) {

								var name = json.javascript[ i ].name;
								var source = json.javascript[ i ].source;

								var script = new Function( "window", source );
								script.call( window ); // execute script in window scope. important!

							//  execute script in one line-code.
							//	( new Function( "window", json.javascript[ i ].source ) )( window ); 

								debugMode && console.log( name + " loaded.");

							}

						}
*/
						renderer = new THREE.WebGLRenderer({ 
							antialias: true,
							preserveDrawingBuffer: true,
						});

						renderer.setClearColor( 0x000000 );
						renderer.setPixelRatio( window.devicePixelRatio );

						if ( json.project.shadows ) {

							renderer.shadowMap.enabled = true;
						//	renderer.shadowMap.type = THREE.PCFSoftShadowMap;

						}

						this.dom.appendChild( renderer.domElement );
						this.setScene( loader.parse( json.scene ) );
						this.setCamera( loader.parse( json.camera ) );

						events = {
							init: [],
							start: [],
							stop: [],
							keydown: [],
							keyup: [],
							mousedown: [],
							mouseup: [],
							mousemove: [],
							touchstart: [],
							touchend: [],
							touchmove: [],
							update: []
						};

						var scriptWrapParams = "player,renderer,scene,camera";
						var scriptWrapResultObj = {};

						for ( var eventKey in events ) {

							scriptWrapParams += "," + eventKey;
							scriptWrapResultObj[ eventKey ] = eventKey;

						}

						var scriptWrapResult = JSON.stringify( scriptWrapResultObj ).replace( /\"/g, "" );

						for ( var uuid in json.scripts ) {

							var object = scene.getObjectByProperty( "uuid", uuid, true );

							if ( object === undefined ) {

								console.warn( "APP.Player: Script without object.", uuid ); continue;

							}

							var scripts = json.scripts[ uuid ];

							for ( var i = 0; i < scripts.length; i ++ ) {

								var script = scripts[ i ];

								var functions = ( new Function( scriptWrapParams, script.source + "\nreturn " + scriptWrapResult + ";" ).bind( object ) )( this, renderer, scene, camera );

								for ( var name in functions ) {

									if ( functions[ name ] === undefined ) continue;

									if ( events[ name ] === undefined ) {

										console.warn( "APP.Player: Event type not supported (", name, ")" ); continue;

									}

									events[ name ].push( functions[ name ].bind( object ) );

								}

							}

						}

						dispatch( events.init, arguments );

					};

				//

					this.setLibraries = function ( value ) {

						libraries = value;

					};

				//

					this.setCamera = function ( value ) {

						camera = value;
						camera.aspect = this.width / this.height;
						camera.updateProjectionMatrix();

						if ( vr === true ) {

							if ( camera.parent === null ) {

								//	camera needs to be in the scene so camera2 matrix updates.

								scene.add( camera );

							}

							var camera2 = camera.clone();
							camera.add( camera2 );

							camera = camera2;

							controls = new THREE.VRControls( camera );
							effect = new THREE.VREffect( renderer );

							if ( WEBVR.isAvailable() === true ) {

								this.dom.appendChild( WEBVR.getButton( effect ) );

							}

							if ( WEBVR.isLatestAvailable() === false ) {

								this.dom.appendChild( WEBVR.getMessage() );

							}

						}

					};

					this.setScene = function ( value ) {

						scene = value;

					};

					this.setSize = function ( width, height ) {

						if ( renderer && renderer._fullScreen ) return;

						this.width = width;
						this.height = height;

						if ( camera ) {

							camera.aspect = this.width / this.height;
							camera.updateProjectionMatrix();

						}

						if ( renderer ) renderer.setSize( width, height );

					};

					function dispatch( array, event ) {

						for ( var i = 0, l = array.length; i < l; i ++ ) {

							array[ i ]( event );

						}

					}

					var prevTime, request;

					function animate( time ) {

						request = requestAnimationFrame( animate );

						try {

							dispatch( events.update, { time: time, delta: time - prevTime } );

						} catch ( e ) {

							console.error( ( e.message || e ), ( e.stack || "" ) );

						}

						if ( vr === true ) {

							controls.update();
							effect.render( scene, camera );

						} else {

							renderer.render( scene, camera );

						}

						prevTime = time;

					}

					this.play = function () {

						document.addEventListener( "keydown", onDocumentKeyDown );
						document.addEventListener( "keyup", onDocumentKeyUp );
						document.addEventListener( "mousedown", onDocumentMouseDown );
						document.addEventListener( "mouseup", onDocumentMouseUp );
						document.addEventListener( "mousemove", onDocumentMouseMove );
						document.addEventListener( "touchstart", onDocumentTouchStart );
						document.addEventListener( "touchend", onDocumentTouchEnd );
						document.addEventListener( "touchmove", onDocumentTouchMove );

						dispatch( events.start, arguments );

						request = requestAnimationFrame( animate );
						prevTime = performance.now();

					};

					this.stop = function () {

						document.removeEventListener( "keydown", onDocumentKeyDown );
						document.removeEventListener( "keyup", onDocumentKeyUp );
						document.removeEventListener( "mousedown", onDocumentMouseDown );
						document.removeEventListener( "mouseup", onDocumentMouseUp );
						document.removeEventListener( "mousemove", onDocumentMouseMove );
						document.removeEventListener( "touchstart", onDocumentTouchStart );
						document.removeEventListener( "touchend", onDocumentTouchEnd );
						document.removeEventListener( "touchmove", onDocumentTouchMove );

						dispatch( events.stop, arguments );

						cancelAnimationFrame( request );

					};

					this.dispose = function () {

						while ( this.dom.children.length ) {

							this.dom.removeChild( this.dom.firstChild );

						}

						renderer.dispose();

					};

				//

					function onDocumentKeyDown( event ) {

						dispatch( events.keydown, event );

					}

					function onDocumentKeyUp( event ) {

						dispatch( events.keyup, event );

					}

					function onDocumentMouseDown( event ) {

						dispatch( events.mousedown, event );

					}

					function onDocumentMouseUp( event ) {

						dispatch( events.mouseup, event );

					}

					function onDocumentMouseMove( event ) {

						dispatch( events.mousemove, event );

					}

					function onDocumentTouchStart( event ) {

						dispatch( events.touchstart, event );

					}

					function onDocumentTouchEnd( event ) {

						dispatch( events.touchend, event );

					}

					function onDocumentTouchMove( event ) {

						dispatch( events.touchmove, event );

					}

				}

			};

		</script>

		<!-- includes -->

		<script>

			bootboxLoading();

			var loader = new THREE.XHRLoader();
			loader.load( "app.json", function ( text ) {

				var json = JSON.parse( text );

				var player = new APP.Player();

				player.load( json );
				player.setSize( window.innerWidth, window.innerHeight );
				player.play();

				document.body.appendChild( player.dom );

				if ( json.project.editable === true ) {

					var button = document.createElement( "div" );
					button.id = "edit";
					button.textContent = "OPEN TO EDITOR";
					button.addEventListener( 'click', function ( event ) {

						var url = location.href.split( "/" ).slice( 0, - 1 ).join( "/" );
						window.open( "https://sloothes.com/three/r78/editor/#file=" + url + "/app.json" );

					}, false );

					document.body.appendChild( button );

				}

				window.addEventListener( "resize", function () {
					player.setSize( window.innerWidth, window.innerHeight );
				});

                bootbox.hideAll();

			});

			function bootboxLoading(){

			//  Loading bar.

				var dialog = window.bootbox.dialog({
					message: "<div class=\"text-center\">"
					+ "<h2 style=\"width:fit-content;font-weight:bold;"
					+ "color:#fff;text-align:center;\">Loading<br>"
					+ "Please wait...<br>(heavy duty)</h2></div>",
					buttons: false,
					closeButton: false,
					className: "middle",
				});

				$( dialog.modal() ).find(".modal-content").css({
                    "border"    : "none",
                    "box-shadow": "none",
                    "background": "none",
				});

			}

			(function(){

			//  Joystick controls.

				var joysticControls1 = document.createElement( "div" );
				var joysticControls2 = document.createElement( "div" );
				joysticControls1.id = "joystick-controls-1";
				joysticControls2.id = "joystick-controls-2";
				joysticControls1.classList.add("joystick-controls");
				joysticControls2.classList.add("joystick-controls");

                document.body.appendChild( joysticControls1 );
                document.body.appendChild( joysticControls2 );

			})();

		</script>
	</body>
</html>
